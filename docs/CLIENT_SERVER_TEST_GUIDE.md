# 客户端-服务器端到端测试指南

**创建日期**: 2025-01-XX  
**测试类型**: 端到端压力测试

---

## 概述

这是一个完整的客户端-服务器端到端测试，测试连接池在实际网络环境下的表现。

### 测试架构

```
┌─────────────────┐         ┌─────────────────┐
│   客户端        │  TCP    │   服务器        │
│  (连接池)       │ ──────> │  (回显服务器)   │
│                 │  UDP    │                 │
│  - TCP客户端    │ ──────> │  - TCP监听      │
│  - UDP客户端    │         │  - UDP监听      │
│  - 混合协议     │         │  - 回显数据     │
└─────────────────┘         └─────────────────┘
```

---

## 测试组件

### 1. 测试服务器 (`test_server.rs`)

**功能**:
- TCP服务器：接受连接，回显数据
- UDP服务器：接收数据包，回显数据
- 统计请求数

**特性**:
- 非阻塞I/O
- 多线程处理
- 自动资源清理

### 2. 全面客户端测试 (`comprehensive_client_test.rs`)

**功能**:
- 集成所有连接池功能
- 支持TCP和UDP协议
- 多种客户端模式

**客户端线程组**:
1. **TCP客户端** (50个线程)
   - 获取TCP连接
   - 发送数据
   - 接收回显
   - 归还连接

2. **UDP客户端** (30个线程)
   - 获取UDP连接
   - 发送数据包
   - 接收回显
   - 归还连接

3. **混合协议客户端** (20个线程)
   - 交替使用TCP和UDP
   - 测试协议切换
   - 测试连接复用

---

## 测试配置

### 连接池配置

```rust
max_connections: 200
min_connections: 20
max_idle_connections: 100
idle_timeout: 60秒
max_lifetime: 300秒
enable_stats: true
enable_health_check: true
```

### 测试参数

- **测试持续时间**: 1小时（可配置）
- **总客户端线程**: 100个
- **监控间隔**: 30秒

---

## 运行测试

### 快速测试（5分钟）

```bash
./test/run_client_server_test.sh 300
```

### 标准测试（1小时）

```bash
./test/run_client_server_test.sh 3600
```

### 长时间测试（2小时）

```bash
./test/run_client_server_test.sh 7200
```

### 直接运行

```bash
cargo test --test comprehensive_client_test test_comprehensive_client_stress -- --ignored --nocapture
```

---

## 测试输出

### 实时监控

测试每30秒输出一次状态：

```
[30s] TCP: 操作=12345, 错误=0 | UDP: 操作=6789, 错误=0 | 连接: 当前=50, 创建=50, 复用=12000
[60s] TCP: 操作=25000, 错误=0 | UDP: 操作=15000, 错误=0 | 连接: 当前=50, 创建=50, 复用=25000
```

### 最终结果

测试完成后会显示：

```
==========================================
全面客户端压力测试结果
==========================================
  运行时间: 1h 0m 0s

  TCP统计:
    操作数: 1,234,567
    错误数: 0
    成功率: 100.00%

  UDP统计:
    操作数: 789,012
    错误数: 0
    成功率: 100.00%

  数据传输:
    发送: 1234.56 MB
    接收: 1234.56 MB
    总流量: 2469.12 MB

  连接池统计:
    当前连接: 50
    创建连接: 50
    关闭连接: 0
    连接复用: 2,000,000
    复用率: 99.50%
    TCP连接: 30
    UDP连接: 20

  服务器统计:
    TCP请求: 1,234,567
    UDP请求: 789,012
```

---

## 测试验证

### 成功标准

1. **高成功率**: TCP和UDP成功率 > 99%
2. **无内存泄漏**: 连接数稳定
3. **高效复用**: 连接复用率 > 90%
4. **无错误**: 错误数应该很少或为0
5. **统计准确**: 客户端和服务器统计应该匹配

### 失败指标

如果出现以下情况，测试失败：

1. ❌ 成功率 < 95%
2. ❌ 连接数持续增长（内存泄漏）
3. ❌ 大量错误
4. ❌ 统计计数器溢出
5. ❌ 系统崩溃或panic

---

## 测试场景覆盖

### ✅ 已测试的功能

1. **TCP连接管理**
   - 连接创建
   - 连接复用
   - 连接归还
   - 连接关闭

2. **UDP连接管理**
   - UDP套接字创建
   - UDP连接复用
   - UDP缓冲区清理

3. **协议切换**
   - TCP和UDP交替使用
   - 连接池自动选择协议

4. **并发处理**
   - 100个并发客户端
   - 高负载场景
   - 连接竞争

5. **长时间运行**
   - 1小时持续运行
   - 内存泄漏检测
   - 稳定性验证

6. **统计功能**
   - 操作计数
   - 错误计数
   - 连接复用统计
   - 数据传输统计

---

## 性能指标

### 预期性能

- **吞吐量**: > 10,000 ops/sec
- **成功率**: > 99%
- **连接复用率**: > 90%
- **延迟**: < 10ms (本地网络)

### 实际测试结果

（运行测试后更新）

---

## 故障排查

### 连接失败

如果出现大量连接失败：
1. 检查服务器是否正常启动
2. 检查端口是否被占用
3. 检查防火墙设置

### 性能下降

如果性能下降：
1. 检查系统资源（CPU、内存）
2. 检查网络状况
3. 调整连接池配置

### 内存泄漏

如果发现内存泄漏：
1. 检查连接是否正确关闭
2. 检查连接池配置
3. 查看详细日志

---

## 日志文件

测试日志保存在：`/tmp/client_server_test_YYYYMMDD_HHMMSS.log`

日志包含：
- 测试配置
- 实时状态报告
- 最终统计结果
- 错误信息（如果有）

---

**最后更新**: 2025-01-XX

