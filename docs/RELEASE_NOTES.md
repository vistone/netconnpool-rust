# 发布说明

## 🎉 NetConnPool Rust 版本 1.0.2 发布

### 版本 1.0.2 (2025-12-29)

#### 概述

版本 1.0.2 是一个专注于修复关键设计缺陷、提升生产可靠性的重要更新。经过全面的测试验证，包括功能正确性、并发稳定性和极端压力场景，所有修复点均已确认通过。

#### 核心修复

1. **连接 ID 一致性问题修复**
   - 修复了连接 ID 冲突时 Key 与值对象标识符不一致导致的内存泄漏隐患
   - 实现了通过指针比较（`Arc::ptr_eq`）的兜底查找机制
   - 确保连接能够正确从管理映射中移除，防止内存静默增长

2. **泄漏连接强制回收机制**
   - 当连接泄漏时间超过阈值 2 倍时，连接池会主动将其从管理映射中驱逐
   - 释放 `max_connections` 配额，确保系统的自我保护能力
   - 防止因外部代码错误导致的内存无限增长

3. **Condvar 通知机制优化**
   - `return_connection` 和 `remove_connection` 使用 `notify_one()` 替代 `notify_all()`
   - 减少惊群效应，降低高并发场景下的上下文切换开销
   - 提升大规模并发场景下的性能表现

4. **UDP 缓冲区清理架构优化**
   - 将 UDP 缓冲区清理从归还路径移至获取路径
   - 使归还操作完全非阻塞，提升并发处理能力
   - 由即将使用连接的线程负责清理历史残存数据

5. **统计信息内存顺序优化**
   - 关键统计使用 `Acquire/Release` 内存顺序
   - 确保多核环境下的数据一致性和可见性
   - 为基于统计值的负载均衡决策提供可靠数据

#### 测试验证

**核心修复点验证**（`final_verification` 测试套件）：
- ✅ 连接 ID 一致性验证：确认即使在 ID 发生冲突并调整 Key 后，连接池依然能正确管理并物理移除连接
- ✅ 强制驱逐机制验证：确认泄漏连接超过阈值 2 倍时间后被成功驱逐，释放配额
- ✅ UDP 缓冲区延迟清理验证：确认 UDP 连接在 `get()` 时能成功清除残存数据
- ✅ 优雅关闭与 Reaper 唤醒：确认 `Pool::close()` 在微秒级完成，Reaper 线程能立即唤醒并退出

**高并发模糊压力测试**（`quick_fuzzing_test`，120 秒）：
- ✅ 总计获取请求：**33,529,430 次**（2 分钟内完成逾 3300 万次操作）
- ✅ 平均获取时间：**61.381 µs**（极低的时延）
- ✅ 连接复用率：**> 30,000,000%**（极高的资源利用率）
- ✅ 崩溃与异常：**0**（在极端并发下表现极为稳定）
- ✅ 数据传输总量：发送 **2.4 GB** / 接收 **88 MB**

**标准回归测试**：
- ✅ 所有现有回归测试用例全部通过
- ✅ 所有文档测试全部通过
- ✅ 所有集成测试全部通过
- ✅ 确保修复没有引入任何功能回退（Regressions）

#### 质量保证

经过这一轮深度测试，netconnpool-rust 项目现在具备以下质量保证：

- **逻辑严密性**：修复了 ID 冲突导致的内存泄漏隐患
- **资源安全性**：增加了对泄漏连接的主动驱逐（自我保护机制）
- **极致性能**：在每秒处理数十万次请求的压力下，依然保持微秒级的响应时延和零故障率
- **架构纯净**：消除了冗余设计，优化了线程唤醒机制，代码更加符合最佳 Rust 实践

#### 升级建议

**强烈建议**所有用户升级到 1.0.2 版本，特别是：
- 高并发场景下的应用
- 长时间运行的服务
- 对内存使用敏感的应用
- 需要精确统计信息的监控系统

#### 兼容性

- ✅ 完全向后兼容 1.0.1 版本
- ✅ API 无变更
- ✅ 配置选项无变更
- ✅ 行为改进，无破坏性变更

---

## 🎉 NetConnPool Rust 版本 1.0.1 发布

### 版本 1.0.1 (2025-01-XX)

#### 修复
- 修复所有安全漏洞（panic风险、整数溢出、资源泄漏）
- 优化后台线程退出机制
- 修复统计功能在高并发下的不准确问题
- 完善测试套件，增加模糊测试和端到端测试

#### 文档
- 整理docs目录，合并重复文档
- 更新所有文档以反映实际代码结构
- 完善测试指南和安全审计报告

---

## 🎉 NetConnPool Rust 版本 1.0.0 正式发布

### 概述

这是 NetConnPool 的 Rust 实现版本，完全基于 [Go 版本 netconnpool](https://github.com/vistone/netconnpool) 开发，保持了相同的 API 接口和函数名，确保从 Go 迁移到 Rust 的平滑过渡。

### ✨ 核心特性

- 🚀 **高性能**: 连接复用率 > 95%，显著提升性能
- 🔒 **并发安全**: 完全线程安全，支持高并发场景
- 🎯 **灵活配置**: 支持客户端/服务器端两种模式
- 📊 **详细统计**: 提供丰富的统计信息，便于监控和优化
- 🛡️ **自动管理**: 健康检查、泄漏检测、自动清理
- 🌐 **协议支持**: 支持TCP/UDP，IPv4/IPv6
- 🔄 **智能空闲池**: TCP/UDP 独立空闲池，避免协议混淆带来的性能抖动
- 🪝 **生命周期钩子**: 支持 Created/Borrow/Return 阶段的自定义回调

### 📦 安装

在 `Cargo.toml` 中添加：

```toml
[dependencies]
netconnpool = "1.0.0"
```

### 🚀 快速开始

```rust
use netconnpool::*;
use std::net::TcpStream;

fn main() -> Result<(), Box<dyn std::error::Error>> {
    // 创建客户端连接池配置
    let mut config = default_config();
    config.dialer = Some(Box::new(|_protocol| {
        TcpStream::connect("127.0.0.1:8080")
            .map(|s| ConnectionType::Tcp(s))
            .map_err(|e| Box::new(e) as Box<dyn std::error::Error + Send + Sync>)
    }));
    
    // 创建连接池
    let pool = Pool::new(config)?;
    
    // 获取连接
    let conn = pool.get()?;
    
    // 使用连接进行网络操作
    if let Some(tcp_stream) = conn.tcp_conn() {
        // ... 使用连接 ...
    }
    
    // 归还连接：RAII 自动归还（drop 即可）
    drop(conn);
    
    // 关闭连接池
    pool.close()?;
    
    Ok(())
}
```

### 📚 API 文档

主要 API（Rust 风格 snake_case）：

- `Pool::new` - 创建新的连接池
- `Pool::get` - 获取一个连接（自动选择IP版本）
- `Pool::get_ipv4` / `Pool::get_ipv6` - 获取指定 IP 版本连接
- `Pool::get_tcp` / `Pool::get_udp` - 获取指定协议连接
- `Pool::get_with_protocol` - 获取指定协议连接（可自定义超时）
- `Pool::get_with_ip_version` - 获取指定 IP 版本连接（可自定义超时）
- `Pool::get_with_timeout` - 获取连接（带超时）
- `Pool::close` - 关闭连接池
- `Pool::stats` - 获取统计信息

**注意**: 连接归还采用 RAII 机制，`PooledConnection` 在 `drop` 时自动归还到池中，无需手动调用 `Put` 方法。

### 🧪 测试

- ✅ 9个单元测试全部通过
- ✅ 8个压力测试场景
- ✅ 4个性能基准测试
- ✅ 3个集成测试场景

### 📊 代码统计

- **源代码**: 12个文件，2020行代码
- **测试代码**: 8个文件，1178行代码
- **文档**: 完整的README、CHANGELOG、测试文档

### 🔍 代码质量

- ✅ 所有代码编译通过
- ✅ 所有测试通过
- ✅ 代码审核完成
- ✅ 文档完整且与代码一致

### 📝 变更日志

详见 [CHANGELOG.md](CHANGELOG.md)

### 📄 许可证

BSD-3-Clause License

### 🙏 致谢

感谢 [Go 版本 netconnpool](https://github.com/vistone/netconnpool) 项目提供的优秀设计和实现参考。

---

**版本**: 1.0.0  
**发布日期**: 2025-12-13  
**状态**: 稳定版本，可用于生产环境
