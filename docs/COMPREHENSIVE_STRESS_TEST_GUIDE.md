# 全面压力测试指南

**创建日期**: 2025-01-XX  
**测试范围**: 长时间运行、内存溢出、资源管理、稳定性

---

## 概述

本测试套件专门设计用于全面验证 NetConnPool Rust 项目在长时间运行、高负载、资源耗尽等极端场景下的表现，特别关注：

1. **内存溢出检测** - 验证统计计数器的溢出检测机制
2. **内存泄漏** - 长时间运行下的资源管理
3. **资源耗尽** - 连接池在极限情况下的行为
4. **长时间稳定性** - 2小时以上的持续运行测试

---

## 测试用例

### 1. 长时间运行全面测试（2小时）

**测试目标**:
- 验证长时间运行下的稳定性
- 检测内存泄漏
- 监控统计计数器溢出风险
- 验证资源管理

**测试配置**:
- 运行时间: 2小时
- 并发线程: 100
- 最大连接数: 500
- 监控间隔: 30秒

**运行命令**:
```bash
cargo test --test comprehensive_stress_test test_long_running_comprehensive -- --ignored --nocapture
```

**预期结果**:
- 无内存泄漏（连接数稳定）
- 统计计数器正常（无溢出）
- 成功率 > 99%
- 连接复用率高

---

### 2. 整数溢出边界测试

**测试目标**:
- 验证统计计数器的溢出检测机制
- 测试大量操作下的计数器行为
- 验证溢出保护是否生效

**测试配置**:
- 总操作数: 1,000,000（100万次）
- 并发线程: 50
- 每线程操作数: 20,000

**运行命令**:
```bash
cargo test --test comprehensive_stress_test test_integer_overflow_boundary -- --ignored --nocapture
```

**预期结果**:
- 所有统计计数器正常（无负数）
- 溢出检测机制正常工作
- 如果接近溢出边界，会输出警告

---

### 3. 资源耗尽测试（30分钟）

**测试目标**:
- 测试连接池在资源耗尽时的行为
- 验证连接数限制是否有效
- 测试错误处理机制

**测试配置**:
- 运行时间: 30分钟
- 并发线程: 200（大量线程竞争连接）
- 最大连接数: 50
- 连接超时: 1秒

**运行命令**:
```bash
cargo test --test comprehensive_stress_test test_resource_exhaustion -- --ignored --nocapture
```

**预期结果**:
- 连接数不超过最大值
- 连接池耗尽时正确返回错误
- 系统稳定运行

---

## 运行所有测试

### 使用测试脚本（推荐）

```bash
./test/run_comprehensive_stress_tests.sh
```

这个脚本会：
1. 提示你确认每个长时间运行的测试
2. 自动记录所有测试日志
3. 定期报告测试进度
4. 在测试完成后生成总结

### 手动运行单个测试

```bash
# 长时间运行测试（2小时）
cargo test --test comprehensive_stress_test test_long_running_comprehensive -- --ignored --nocapture

# 整数溢出测试
cargo test --test comprehensive_stress_test test_integer_overflow_boundary -- --ignored --nocapture

# 资源耗尽测试（30分钟）
cargo test --test comprehensive_stress_test test_resource_exhaustion -- --ignored --nocapture
```

---

## 监控和日志

### 测试日志位置

所有测试日志保存在 `/tmp/comprehensive_stress_YYYYMMDD_HHMMSS/` 目录下。

### 实时监控

长时间运行的测试会每30秒输出一次状态报告，包括：
- 运行时间
- 操作数统计
- 错误数
- 当前连接数
- 连接创建/关闭数
- 连接复用数
- 溢出风险警告

### 内存监控

测试会定期采样内存使用情况，包括：
- 当前连接数
- 总创建连接数
- 总关闭连接数
- 活跃/空闲连接数

---

## 测试结果分析

### 成功标准

1. **无内存泄漏**:
   - 连接数在合理范围内波动
   - 最终连接数不超过初始连接数 + 50

2. **无整数溢出**:
   - 所有统计计数器 >= 0
   - 无溢出警告（除非接近边界）

3. **高稳定性**:
   - 成功率 > 99%
   - 无 panic 或崩溃
   - 系统持续稳定运行

4. **资源管理正确**:
   - 连接数不超过配置的最大值
   - 连接正确创建和关闭
   - 无资源泄漏

### 失败指标

如果出现以下情况，测试失败：

1. ❌ 统计计数器变为负数（溢出）
2. ❌ 连接数持续增长（内存泄漏）
3. ❌ 连接数超过最大值
4. ❌ 系统 panic 或崩溃
5. ❌ 成功率 < 95%

---

## 测试时间估算

| 测试用例 | 预计时间 | 说明 |
|---------|---------|------|
| 长时间运行全面测试 | 2小时 | 最全面的测试 |
| 整数溢出边界测试 | 5-10分钟 | 快速验证溢出检测 |
| 资源耗尽测试 | 30分钟 | 测试资源管理 |
| **总计** | **约3小时** | 完整测试套件 |

---

## 注意事项

1. **系统资源**: 长时间运行测试会消耗大量 CPU 和内存，确保系统有足够资源

2. **网络**: 测试需要本地 TCP 服务器，确保端口可用

3. **时间**: 完整测试需要数小时，建议在非工作时间运行

4. **监控**: 建议在测试期间监控系统资源使用情况

5. **日志**: 测试日志可能很大，确保有足够的磁盘空间

---

## 故障排查

### 测试超时

如果测试超时，检查：
- 系统资源是否充足
- 是否有其他进程占用资源
- 网络连接是否正常

### 内存泄漏警告

如果出现内存泄漏警告：
1. 检查日志中的连接数趋势
2. 确认是否有连接未正确关闭
3. 检查连接池配置

### 整数溢出警告

如果出现溢出警告：
1. 这是正常的，说明溢出检测机制工作正常
2. 检查统计计数器的值
3. 确认是否需要调整计数器类型

---

## 测试报告

测试完成后，检查日志文件中的：

1. **最终统计信息** - 所有操作的汇总
2. **内存使用趋势** - 连接数变化趋势
3. **溢出检测结果** - 是否有溢出或警告
4. **性能指标** - 吞吐量、成功率等

---

**最后更新**: 2025-01-XX

